{% extends "base.html" %}
{% block content %}
<div id="settings" style="display: none;">
    <span class="close mobile_close" onclick="trigger_modal('settings')">&times;</span>
    <h2>Settings</h2>
    <ul>
      <li><a href="/feeds">Following</a></li>
      <li><a href="/channels">Channels</a></li>
      <li><a href="/search">Search</a></li>
      <li><a href="/explore">Explore</a></li>
      <li><a href="/settings">Logged in as {{ session.get("me").replace("https://", "").strip("/") }}</a></li>
      <li><a href="/logout">Logout</a></li>
    </ul>
  </div>
<div style="display: flex; flex-wrap: wrap; flex-direction: row; margin-top: 15px;">
<section class="feed flex_right_home">
    <ul id="feed_list">
        <li style="text-align: right;">
            <textarea rows="8" placeholder="Express yourself..." aria-labelledby="Post content" id="content" name="content"></textarea>
            <input type="file" id="post_image" style="display: none;"><label for="post_image" style="padding: 10px; float: left;">ðŸ“·</label><span onclick="add_rsvp_text()">ðŸ“…</span>(<span id="character_count">0</span>)
            <p id="data_message"></p>
            <button id="post_button" style="width: 100px; text-align: center;" onclick="post_note()">Post</button>
        </li>
    {% if results | length > 0 %}
    {% set count = namespace(value=0) %}
      {% for w in results %}
        {% if (count.value > 0 and published_dates[count.value-1] and published_dates[count.value-1][:8] != published_dates[count.value][:8]) or count.value == 0 %}
            {% if w.get("published") %}
            <li>
                <h2>{{ w["published"] | strftime }}</h2>
            </li>
            {% endif %}
            {% endif %}
            {% include "client/feed_item.html" %}
        {% set count.value = count.value + 1 %}
        {% endfor %}
        </ul>
    {% else %}
    </ul>
    <p class="content_box">There are no posts in this channel. Check back later to see if any posts are added.</p>
    {% endif %}
    {% if after != "" or before != "" %}
        <div class="bottom-navigation">
            {% if before != "" %}
                <div class="prev">
                    <p><a href="/reader/{{ page_channel_uid }}?before={{ before }}">See Older Posts</a></p>
                </div>
            {% endif %}
            {% if after != "" %}
            <div class="next">
                <p><a href="/reader/{{ page_channel_uid }}?after={{ after }}">See Newer Posts</a></p>
            </div>
            {% endif %}
        </div>
    {% endif %}
</section>
<section id="podcast_overlay" class="podcast" style="display: none; border-radius: 10px;">
    <p id="podcast_info"></p>
    <audio id="focused_audio"></audio>
    <div id="podcast_controls">
        <button id="podcast_play" class="podcast_controls" onclick="play_podcast()">Play</button>
        <button id="podcast_pause" class="podcast_controls" onclick="pause_podcast()">Pause</button>
    </div>
</section>
</div>
<section class="content_box modal" style="display: none;" id="subscribe">
    <div class="modal_content">
        <span class="close" onclick="trigger_modal('subscribe')">&times;</span>
        <h2>Subscribe to a Feed</h2>
        <p>Use the form below to subscribe to a feed.</p>
        <p>You can subscribe to RSS, Microformats 2, and JSON Feed feeds.</p>
        <form action="/preview" method="GET">
        <label for="channel">Channel Name:</label><br>
        <select name="channel" id="channel">
            {% for channel in channels %}
                {% if channel.uid != "all" %}
                    <option value="{{ channel.uid }}" {% if channel.uid == page_channel_uid %}selected{% endif %}>{{ channel.name }}</option>
                {% endif %}
            {% endfor %}
        </select><br>
        <label for="url">Feed Address:</label><br>
        <input id="url" type="url" name="url" placeholder="https://jamesg.blog/feed.xml" /><br>
        <input type="submit" value="Preview Subscription" />
        </form>
    </div>
</section>
<section class="content_box modal" style="display: none;" id="channel_settings">
    <div class="modal_content">
        <span class="close" onclick="trigger_modal('channel_settings')">&times;</span>
        <h2>Channel Settings</h2>

        <h3>Rename Channel</h3>
        <form action="/channel/{{ page_channel_uid }}" method="POST">
            <label for="name">Channel Name:</label><br>
            <input type="text" name="name" id="name" value="{{ channel_name }}" placeholder="Channel name"><br>
            <input type="hidden" name="method" id="method" value="delete">
            <input type="hidden" name="action" id="action" value="channels">
            <input type="submit" value="Rename Channel">
        </form>

        <h3>Delete Channel</h3>
        <p>You can delete this channel using the button below.</p>
        <p>Deleting a channel is irreversible.</p>
        <form action="/delete-channel" method="POST">
            <input type="hidden" name="channel" id="channel_item" value="{{ page_channel_uid }}">
            <input type="hidden" name="method" id="method" value="delete">
            <input type="hidden" name="action" id="action" value="channels">
            <input type="submit" value="Delete Channel">
        </form>
    </div>
</section>
<section class="content_box modal" style="display: none;" id="search">
    <div class="modal_content">
        <span class="close" onclick="trigger_modal('search')">&times;</span>
        <h2>Search for a post</h2>
        <p>Use the form below to find a blog post in your feed.</p>
        <form method="GET" action="/search" role="search">
            <input type="hidden" name="channel" value="{{ page_channel_uid }}">
            <input type="text" name="query" placeholder="Search for a post" aria-label="Search for a post" class="search_bar" style="width: 75%;">
            <button class="search_button" style="width: 25%;">Search</button>
        </form>
    </div>
</section>
<script>
    var form = document.getElementById("content");

    var character_count_element = document.getElementById("character_count");

    form.onkeydown = function(e) {
        character_count_element.innerHTML = form.value.length;
    }

    var post_image = document.getElementById("post_image");

    post_image.addEventListener("change", function() {
        var file = this.files[0];
        uploadFile(file);
    });

    // draggable code derived from https://www.smashingmagazine.com/2018/01/drag-drop-file-uploader-vanilla-js/
    ;['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        form.addEventListener(eventName, preventDefaults, false)
    })

    function preventDefaults (e) {
        e.preventDefault()
        e.stopPropagation()
    }

    form.addEventListener('dragover', handleDragOver) 

    function handleDragOver(e) {
        e.preventDefault()
        e.stopPropagation()

        var data_message = document.getElementById("data_message");

        data_message.innerHTML = "Drop an image into the box above to upload it to your site.";
        data_message.className = "data_message";

        form.after(data_message);

        form.classList.add('dragover')
    }

    form.addEventListener('dragleave', handleDragLeave)
    
    function handleDragLeave(e) {
        e.preventDefault()
        e.stopPropagation()

        var data_message = document.getElementById("data_message");

        data_message.innerHTML = "";
        data_message.className = "";
        
        form.classList.remove('dragover')
    }

    form.addEventListener('drop', handleDrop, false)

    function handleDrop(e) {
        let dt = e.dataTransfer
        let files = dt.files

        handleFiles(files)
        handleDragLeave()
    }

    function handleFiles(files) {
        ([...files]).forEach(uploadFile)
    }

    function uploadFile(file) {
        let formData = new FormData()

        formData.append('file', file)

        fetch("/media", {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(function(response) {
            var uploaded_files = document.createElement("p");

            uploaded_files.innerHTML = "Uploaded " + response["result"];
            uploaded_files.classList.add("success");
            form.value += "<img class='u-photo' src='" + response["result"] + "' alt='' />";

            form.after(uploaded_files);

            send_notification("<p>Your photo was successfully uploaded.</p>")
        })
        .catch(() => { send_notification("<p>Your photo could not be uploaded.</p>") })
    }

    function get_reader_data() {
        var xhr = new XMLHttpRequest();
        xhr.open("GET", "/retrieve?last_id={{ last_id }}&channel={{ page_channel_uid }}");
        xhr.onreadystatechange = function() {
            if (xhr.readyState == 4 && xhr.status == 200) {
                var data = JSON.parse(xhr.responseText);
                if (data["last_id"] != "{{ last_id }}") {
                    var feed_list = document.getElementById("feed_list");
                    if (document.getElementById("feed_notification")) {
                        var new_feed_list_item = document.getElementById("feed_notification");
                    } else {
                        var new_feed_list_item = document.createElement("li");
                    }

                    new_feed_list_item.setAttribute("onclick", "location.reload()");
                    new_feed_list_item.setAttribute("id", "feed_notification");
                    new_feed_list_item.classList.add("success");

                    new_feed_list_item.innerHTML = "There are new posts in this channel. Click here to refresh and see the new posts.";

                    // add new post notification as first item
                    feed_list.insertBefore(new_feed_list_item, feed_list.firstChild);
                }
            }
        }
        xhr.send();
    }
    // make reader request every minute
    setInterval(get_reader_data, 60000);

    function add_rsvp_text() {
        form.value += "I am RSVP'ing <span class='p-rsvp'>yes</span> to <a href='' class='in-reply-to'>Event</a>.";
    }
</script>

{% endblock %}