{% extends "base.html" %}
{% block content %}
<style>
    .feed li {
        background: white;
        border-radius: 15px;
        border: 1px solid lightgrey;
        margin-bottom: 10px;
        padding: 10px;
    }
</style>
{% with messages = get_flashed_messages() %}
    {% if messages %}
    <section class="notification">
    {% for message in messages %}
        <p>{{ message }}</p>
    {% endfor %}
    </section>
    {% endif %}
{% endwith %}
<div style="display: flex; flex-wrap: wrap; flex-direction: row; margin-top: 15px;">
<aside class="flex_left_home">
    <h2>Your Channels</h2>
    <ul>
        {% if page_channel_uid == "all" %}
        <li><a href="/reader/all" style="font-weight: 600;">All 📝</a></li>
        {% else %}
        <li><a href="/reader/all">All 📝</a></li>
        {% endif %}
        {% for channel in channels %}
        <li>
            {% if channel.uid == page_channel_uid %}
            <a href="/reader/{{ channel.uid }}" style="font-weight: 600;">{{ channel.name }} {% if channel.unread > 0 %}({{ channel.unread }}){% endif %}</a>
            {% else %}
            <a href="/reader/{{ channel.uid }}">{{ channel.name }} {% if channel.unread > 0 %}({{ channel.unread }}){% endif %}</a>
            {% endif %}
        </li>
        {% endfor %}
    </ul>
    {% if results | length > 0 %}
        <form method="POST" action="/read">
            <input type="hidden" name="channel" value="{{ page_channel_uid }}">
            <input type="hidden" name="status" value="mark_read">
            <input type="hidden" name="last_read_entry" value="{{ results[-1]['_id'] }}">
            <button>Mark All As Read</button>
        </form>
        <form method="POST" action="/read">
            <input type="hidden" name="channel" value="{{ page_channel_uid }}">
            <input type="hidden" name="status" value="mark_unread">
            <input type="hidden" name="last_read_entry" value="{{ results[-1]['_id'] }}">
            <button>Mark All as Unread</button>
        </form>
    {% endif %}
</aside>
<section class="feed flex_right_home">
    {% if results | length > 0 %}
    <ul>
      {% for w in results %}
      {% if (w.index > 0 and published_dates[w.index-1] and published_dates[w.index-1][:8] != published_dates[w.index][:8]) or w.index == 0 %}
        {% if w.get("published") %}
        <p>{{ w["published"] | strftime }}</p>
        {% endif %}
        {% endif %}
        <li {% if w["_is_read"] == False %}class="unread"{% endif %}>
            {% if w.get("name") %}
            <h3><a href='{{ w["url"] }}'>{{ w["name"] }}</a></h3>
            {% elif w.get("author") and w.get("author").get("name") %}
            <h3><a href='{{ w["url"] }}'>Post by {{ w["author"]["name"] }}</a></h3>
            {% endif %}
            {% if w.get("published") %}
            <p>Published on {{ w["published"] | strftime }}.</p>
            {% endif %}
            {% if w.get("photo") %}
            <img src='{{ w["photo"] }}' alt='{{ w["name"] }} header photo' />
            {% endif %}
            {% if w.get("content") and w["content"].get("text") %}
            {% capture content %}{{ w["content"]["text"].split(" ")[:75] }}{% endcapture %}
            <p>{{ " ".join(content) }}</p>{% if content | length > 75 %}...{% endif %}</p>
            {% else %}
            <p><a href='{{ w["url"] }}'>Read the full post.</a></p>
            {% endif %}
            <p>
                <a href="https://micropub.jamesg.blog/post?type=like&like-of={{ w['url'] }}" class="reaction">Like ❤️</a>
                <a href="https://micropub.jamesg.blog/post?type=bookmark&bookmark-of={{ w['url'] }}" class="reaction">Bookmark 🔖</a>
                <a href="https://micropub.jamesg.blog/post?type=repost&repost-of={{ w['url'] }}" class="reaction">Repost 🔁</a>
                <a href="https://micropub.jamesg.blog/post?in-reply-to={{ w['url'] }}" class="reaction">Reply 💬</a>
                <a href="/reader/{{ page_channel_uid }}/delete/{{ w['_id'] }}" class="reaction">Delete 🗑️</a>
            </p>
        </li>
      {% endfor %}
    </ul>
    {% else %}
    <p class="content_box">There are no posts in this channel. Check back later to see if any posts are added.</p>
    {% endif %}
</section>
</div>
<section>
    {% if before == True %}
    <p><a href="/">See Newer Posts</a></p>
    {% endif %}
    <p><a href="/">See Older Posts</a></p>
</section>
{% endblock %}