{% extends "base.html" %}
{% block content %}
<div style="display: flex; flex-wrap: wrap; flex-direction: row; margin-top: 15px;">
<section class="feed flex_right_home">
    <ul id="feed_list">
        {% if channels[1]['uid'] != channel_id %}
            <li style="text-align: right;">
                <textarea rows="8" placeholder="Express yourself..." aria-labelledby="Post content" id="content" name="content"></textarea>
                <div class="post_container_footer" style="display: flex;">
                    <p class="reaction_set flex_left_home" style="margin-top: 0; width: initial;">
                        <input type="file" id="post_image" style="display: none;">
                        <label for="post_image" class="reaction">üì∑</label>
                        <span onclick="add_rsvp_text()" class="reaction">üìÖ</span>
                        <span onclick="add_review_text()" class="reaction">‚≠ê</span>
                    </p>
                    <div class="flex_right_home">
                        (<span id="character_count">0</span>)
                        <p id="data_message"></p>
                    </div>
                </div>
                <button id="post_button" style="width: 100px; text-align: center;" onclick="post_note()">Post</button>
            </li>
        {% endif %}
    {% if results | length > 0 %}
    {% set count = namespace(value=0) %}
      {% for w in results %}
        {% if (count.value > 0 and published_dates[count.value-1] and published_dates[count.value-1][:8] != published_dates[count.value][:8]) or count.value == 0 %}
            {% if w.get("published") %}
            <li>
                <h2>{{ w["published"] | strftime }}</h2>
            </li>
            {% endif %}
            {% endif %}
            {% include "client/feed_item.html" %}
        {% set count.value = count.value + 1 %}
        {% endfor %}
        {% if after != "" or before != "" %}
            <li style="display: flex;">
                {% if before != "" %}
                    <div style="width: 50%; text-align: center;">
                        <p><a href="/reader/{{ page_channel_uid }}?before={{ before }}">See Older Posts</a></p>
                    </div>
                {% endif %}
                {% if after != "" %}
                <div style="width: 50%; text-align: center;">
                    <p><a href="/reader/{{ page_channel_uid }}?after={{ after }}">See Newer Posts</a></p>
                </div>
                {% endif %}
            </li>
        {% endif %}
        </ul>
    {% else %}
    </ul>
    <p class="content_box">There are no posts in this channel. Check back later to see if any posts are added.</p>
    {% endif %}
</section>
<section id="podcast_overlay" class="podcast" style="display: none; border-radius: 10px;">
    <p id="podcast_info"></p>
    <audio id="focused_audio"></audio>
    <div id="podcast_controls">
        <button id="podcast_play" class="podcast_controls" onclick="play_podcast()">Play</button>
        <button id="podcast_pause" class="podcast_controls" onclick="pause_podcast()">Pause</button>
    </div>
</section>
</div>
<section class="content_box modal" style="display: none;" id="channel_settings">
    <div class="modal_content">
        <span class="close" onclick="trigger_modal('channel_settings')">&times;</span>
        <h2>Channel Settings</h2>

        <h3>Rename Channel</h3>
        <form action="/channel/{{ page_channel_uid }}" method="POST">
            <label for="name">Channel Name:</label><br>
            <input type="text" name="name" id="name" value="{{ channel_name }}" placeholder="Channel name"><br>
            <input type="hidden" name="method" id="method" value="delete">
            <input type="hidden" name="action" id="action" value="channels">
            <input type="submit" value="Rename Channel">
        </form>

        <h3>Delete Channel</h3>
        <p>You can delete this channel using the button below.</p>
        <p>Deleting a channel is irreversible.</p>
        <form action="/delete-channel" method="POST">
            <input type="hidden" name="channel" id="channel_item" value="{{ page_channel_uid }}">
            <input type="hidden" name="method" id="method" value="delete">
            <input type="hidden" name="action" id="action" value="channels">
            <input type="submit" value="Delete Channel">
        </form>
    </div>
</section>
<script>
    var form = document.getElementById("content");

    var character_count_element = document.getElementById("character_count");

    form.onkeydown = function(e) {
        character_count_element.innerHTML = form.value.length;
    }

    var post_image = document.getElementById("post_image");

    post_image.addEventListener("change", function() {
        var file = this.files[0];
        uploadFile(file);
    });

    // draggable code derived from https://www.smashingmagazine.com/2018/01/drag-drop-file-uploader-vanilla-js/
    ;['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        form.addEventListener(eventName, preventDefaults, false)
    })

    function preventDefaults (e) {
        e.preventDefault()
        e.stopPropagation()
    }

    form.addEventListener('dragover', handleDragOver) 

    function handleDragOver(e) {
        e.preventDefault()
        e.stopPropagation()

        var data_message = document.getElementById("data_message");

        data_message.innerHTML = "Drop an image into the box above to upload it to your site.";
        data_message.className = "data_message";

        form.after(data_message);

        form.classList.add('dragover')
    }

    form.addEventListener('dragleave', handleDragLeave)
    
    function handleDragLeave(e) {
        e.preventDefault()
        e.stopPropagation()

        var data_message = document.getElementById("data_message");

        data_message.innerHTML = "";
        data_message.className = "";
        
        form.classList.remove('dragover')
    }

    form.addEventListener('drop', handleDrop, false)

    function handleDrop(e) {
        let dt = e.dataTransfer
        let files = dt.files

        handleFiles(files)
        handleDragLeave()
    }

    function handleFiles(files) {
        ([...files]).forEach(uploadFile)
    }

    function uploadFile(file) {
        let formData = new FormData()

        formData.append('file', file)

        fetch("/media", {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(function(response) {
            var uploaded_files = document.createElement("p");

            uploaded_files.innerHTML = "Uploaded " + response["result"];
            uploaded_files.classList.add("success");
            form.value += "<img class='u-photo' src='" + response["result"] + "' alt='' />";

            form.after(uploaded_files);

            // after 10 seconds, remove the success message
            setTimeout(function() {
                uploaded_files.remove();
            }, 10000);

            send_notification("<p>Your photo was successfully uploaded.</p>")
        })
        .catch(() => { send_notification("<p>Your photo could not be uploaded.</p>") })
    }

    function get_reader_data() {
        var xhr = new XMLHttpRequest();
        xhr.open("GET", "/retrieve?last_id={{ last_id }}&channel={{ page_channel_uid }}");
        xhr.onreadystatechange = function() {
            if (xhr.readyState == 4 && xhr.status == 200) {
                var data = JSON.parse(xhr.responseText);
                if (data["last_id"] != "{{ last_id }}") {
                    var feed_list = document.getElementById("feed_list");
                    if (document.getElementById("feed_notification")) {
                        var new_feed_list_item = document.getElementById("feed_notification");
                    } else {
                        var new_feed_list_item = document.createElement("li");
                    }

                    new_feed_list_item.setAttribute("onclick", "location.reload()");
                    new_feed_list_item.setAttribute("id", "feed_notification");
                    new_feed_list_item.classList.add("success");

                    new_feed_list_item.innerHTML = "There are new posts in this channel. Click here to refresh and see the new posts.";

                    // add new post notification as first item
                    feed_list.insertBefore(new_feed_list_item, feed_list.firstChild);
                }
            }
        }
        xhr.send();
    }
    // make reader request every minute
    setInterval(get_reader_data, 60000);

    function add_rsvp_text() {
        form.value += "I am RSVP'ing <span class='p-rsvp'>yes</span> to <a href='' class='in-reply-to'>Event</a>.";
    }

    function add_review_text() {
        form.value += "Review of <span class='p-name'>Review</span>. <span class='p-rating'>5</span>/5.";
    }
</script>

{% endblock %}